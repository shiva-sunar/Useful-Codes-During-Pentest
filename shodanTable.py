import requests;
import sys;
#if requests is not installed then
#pip install requests
#usage python script.py fileWithListOfIPs.txt

parameter={'key':"BCp2UtnFhRcpCq2hYZrXJ9YcRFiDa33F"};
shodanAddress="https://api.shodan.io/shodan/host/";
bodyHTML= """
<!DOCTYPE html>
<html>
<head>
  <title>Shodan Table</title>
</head>
<body>
  <table border="1">
  <tr>
    <th>SN</th>
    <th>IP</th>
    <th>Port</th>
    <th>Service</th>
  </tr>
@@@table
</table>
</body>
</html>
"""
hostRowHTML= """
<tr>
    <td rowspan="@@@portLength">@@@sn</td>
    <td rowspan="@@@portLength">@@@ipAddress</td>
    @@@firstPort
</tr>"""
portRowHTML= """
<tr>
    <td>@@@portNumber</td>
    <td>@@@portDetail</td>
</tr>"""


def isResponseEmpty(json):
    if(str(json).__contains__("No information available for that IP.")):
        return True;
    return False;

fname=sys.argv[1];
with open(fname) as f:
    content = f.readlines();

ipList=[x.strip() for x in content];
allRows= "";

successful = 0;
failed = 0;
for i in range(0,len(ipList)):
    ip=ipList[i]; print ip;
    r=requests.get(url=shodanAddress+ip,params=parameter);
    jsonObject=r.json();

    if isResponseEmpty(jsonObject):
        print "No information available for that IP.:::"+ip+"\n\n";
        failed+=1;
        continue;
    successful+=1;

    numberOfPort="1";
    transport="tcp";
    port="0";
    module="None";
    try:
        transport=str(jsonObject['data'][0]['transport']);
        port=str(jsonObject['data'][0]['port']);
        numberOfPort=str(len(jsonObject['data']));
        module=str(jsonObject['data'][0]['_shodan']['module']);
    except:
        print "Error Occured"+ip+"\n"+transport+"\n"+port+"\n"+module+"\n";

    firstPortString="<td>"+transport+":"+port+"</td><td>"+module+"</td>";
    ipRow=hostRowHTML\
        .replace('@@@portLength',numberOfPort)\
        .replace('@@@ipAddress',ip)\
        .replace('@@@sn',str(successful))\
        .replace('@@@firstPort',firstPortString);

    if int(numberOfPort)> 1:
        for p in range(1,int(numberOfPort)):
            try:
                transport = str(jsonObject['data'][p]['transport']);
                port = str(jsonObject['data'][p]['port']);
                module = str(jsonObject['data'][p]['_shodan']['module']);
            except:
                print "Error Occured:\nIP:" + ip + "\nProtocol:" + transport + "-" + port + "\n" + module + "\n";

            ipRow+=portRowHTML\
                .replace('@@@portNumber',transport+":"+port)\
                .replace('@@@portDetail',module);
    allRows+=ipRow;

finalHTML=bodyHTML.replace('@@@table', allRows);
file=open("C:\Users\ShiPC\Desktop\shodanIPPort.html","w");
file.write(finalHTML);

