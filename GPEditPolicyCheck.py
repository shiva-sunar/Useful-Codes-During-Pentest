#It is tool for auditing the Group Policy Settings.
#all the files should be in one folder
#List of the policies to check should be in file named 'GroupPolicies.txt'
#Exported Group Policy of the client should be named in format 'IPAddress.policy' ie 192.168.0.1.policy
#All the Exported Policy should be in same folder.
#usage python GPEditPolicyCheck.py
import sys, os;


def fileLineToList(fname):#returns list of lines from text file named fname
    with open(fname) as f:
        contents = [x.strip("\n") for x in f.readlines()]
    return contents;


def splitByTab(line):#returns like "apple ball cat" --> ("apple","ball","cat")
    return line.split("\t");


def tuplize(lines):
    tuples = [];
    for line in lines:
        tupl = splitByTab(line);
        tuples.append(tupl);
    return tuples;


def policyCheckForOne(clientFileName, standardPoliciesToCheck):
    ip = clientFileName.split("\\")[-1].replace(".policy", "");#IPFileName.policy --> IPFileName
    checkedResults = [];
    clientPolicies = tuplize(fileLineToList(clientFileName));#List of (policyName,status,remarks,etc...)
    for clientPolicy in clientPolicies:
        for standardPolicy in standardPoliciesToCheck:
            if (standardPolicy == clientPolicy[0]):
                checkedResults.append((ip, clientPolicy[0], clientPolicy[1]))
    return checkedResults;


def getAllCombinedResults():#list of (ip,policyNmae,policyStatus) for all IPs.
    standardPolicies = fileLineToList(os.getcwd() + "\GroupPolicies.txt");  # the stanadard policies to check.
    allCombinedResult=[];
    for f in [x for x in os.listdir(os.getcwd()) if x.endswith('.policy')]:  # Get all '.policy' file from current directory
        resultF = policyCheckForOne(f, standardPolicies);  # returns list (IP,policyName,policyStatus)
        for r in resultF:
            allCombinedResult.append(r);
    return allCombinedResult;

def allNotConfigured():
    allResults=getAllCombinedResults();#list of (IP,policyName,PolicyStatus) for all ips;
    standardPolicies = fileLineToList(os.getcwd() + "\GroupPolicies.txt");  # the stanadard policies to check.
    ipsCombined=[];
    for s in standardPolicies:
        tempIPCombined=(s,[]);
        for a in allResults:
            if(s==a[1] and a[2]=="Not configured"):
                tempIPCombined[1].append(a[0]);
        ipsCombined.append(tempIPCombined);
    return ipsCombined;

def start():
    ipCombinedConfiguration=allNotConfigured();
    for i in ipCombinedConfiguration:
        if len(i[1]) > 0:
            print "\""+i[0]+"\" Policy is NOT CONFIGURED.";
            temp="";
            for ip in i[1]:
                temp+=ip+", ";
            print temp;

start();
